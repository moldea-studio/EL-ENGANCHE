<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>El Capit√°n - F√∫tbol Amateur</title>
    
    <!-- PWA Settings -->
    <meta name="theme-color" content="#00ff55">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="El Capit√°n">
    <link rel="apple-touch-icon" id="apple-icon">
    <link rel="icon" type="image/png" id="favicon">
    <link rel="manifest" id="manifest-placeholder">

    <!-- CONFIGURACI√ìN DE √çCONOS REALES -->
    <script>
        (function() {
            const iconUrl = "https://i.imgur.com/evLI09R.png";
            document.getElementById('apple-icon').href = iconUrl;
            document.getElementById('favicon').href = iconUrl;
            const manifest = {
                "name": "El Capit√°n",
                "short_name": "El Capit√°n",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#111827",
                "theme_color": "#00ff55",
                "orientation": "portrait",
                "icons": [
                    { "src": iconUrl, "sizes": "192x192", "type": "image/png" },
                    { "src": iconUrl, "sizes": "512x512", "type": "image/png" }
                ]
            };
            const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            document.getElementById('manifest-placeholder').setAttribute('href', URL.createObjectURL(blob));
        })();
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Estilos base -->
    <style>
        body { background-color: #111827; color: #e5e7eb; font-family: sans-serif; padding-bottom: 100px; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #00ff55; border-radius: 4px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #root { min-height: 100vh; display: flex; flex-direction: column; }
        #error-display { display: none; padding: 20px; color: #ff6b6b; background: #2d1b1b; text-align: center; }
        .modal-animate { animation: fadeIn 0.2s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* FIX PARA CALENDARIO Y RELOJ EN WEB (PC) */
        ::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
            opacity: 0.8;
        }
        ::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div id="error-display"></div>
    <div id="root">
        <div class="flex-1 flex items-center justify-center text-[#00ff55] animate-pulse">
            <svg class="w-10 h-10 animate-spin mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
            </svg>
            Cargando El Capit√°n...
        </div>
    </div>

    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Users, MapPin, Calendar, Shield, Search, PlusCircle, AlertCircle, 
            ChevronRight, ChevronDown, ChevronUp, Swords, Star, Menu, X, Filter, 
            Link as LinkIcon, User, LogOut, Mail, Lock, Trash2, Ban, Trophy, 
            Activity, ArrowLeft, HelpCircle, FileText, Lock as LockIcon, Bell, 
            CheckCircle, XCircle, Send, Crown, UserPlus, Share2, Edit2, Save, MinusCircle,
            Home, Zap, ClipboardList, AlertTriangle, Download, UserCheck, UserX, Clock, MessageCircle, Beer, Flame, Banknote, Image as ImageIcon, Camera, ChevronDown as ChevDown, ChevronUp as ChevUp, Info, Check, X as XIcon, Inbox
        } from 'https://esm.sh/lucide-react@0.294.0';
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app-check.js';
        import { 
            getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged,
            signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile,
            signInAnonymously, signInWithCustomToken
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
           getFirestore, collection, query, onSnapshot, doc, updateDoc, increment, 
           arrayUnion, arrayRemove, addDoc, serverTimestamp, deleteDoc, where, 
           orderBy, getDoc, setDoc, getDocs, Timestamp, enableIndexedDbPersistence 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // --- DEFINICIONES GLOBALES ---
        const appId = 'el-capitan-web';
        const ADMIN_EMAILS = ["worlddigital2011@gmail.com", "admin@elenganche.com", "eyamilgimenez98@gmail.com"];
        
        const LA_PLATA_ZONES = [
            "Todas", "La Plata (Casco Urbano)", "City Bell", "Villa Elisa", 
            "Manuel B. Gonnet", "Arturo Segu√≠", "Ringuelet", "Tolosa", 
            "Los Hornos", "San Carlos", "Villa Elvira", "Altos de San Lorenzo", 
            "Villa Castells", "Joaqu√≠n Gorina", "Jos√© Hern√°ndez", "Lisandro Olmos", 
            "Melchor Romero", "Abasto", "Etcheverry", "El Peligro", "Sicardi / Villa Garibaldi"
        ];
        
        const ZONES_BY_AREA = {
            "Casco Urbano": ["La Plata (Casco Urbano)"],
            "Zona Norte": ["Arturo Segu√≠", "Villa Elisa", "City Bell", "Manuel B. Gonnet", "Ringuelet", "Tolosa", "Villa Castells", "Joaqu√≠n Gorina", "Jos√© Hern√°ndez"],
            "Zona Oeste": ["San Carlos", "Los Hornos", "Lisandro Olmos", "Melchor Romero", "Abasto", "Etcheverry", "El Peligro"],
            "Zona Sur": ["Villa Elvira", "Altos de San Lorenzo", "Sicardi / Villa Garibaldi"],
            "Zona Este": ["Ensenada", "Berisso"]
        };

        const MATCH_LEVELS = ["Tranqui / Joda üçª", "Picado Medio ‚öΩ", "A Morir (Competitivo) üèÜ"];
        const MATCH_GENDERS = ["Hombres üöπ", "Mujeres üö∫", "Mixto ‚ößÔ∏è"];
        const POSITIONS_LIST = ["Arquero", "Defensor", "Medio", "Delantero", "Polifuncional"];
        
        // REGLAS DE NEGOCIO
        const DAYS_BETWEEN_UPDATES = 30;
        const MAX_ACTIVE_APPLICATIONS_PER_USER = 4;
        const MAX_APPLICATIONS_PER_SLOT = 10; // 10 solicitudes por puesto faltante

        const today = new Date().toISOString().split('T')[0];
        const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];
        const yesterdayString = new Date(Date.now() - 86400000).toISOString().split('T')[0];
        const sevenDaysAgoString = new Date(Date.now() - 86400000 * 7).toISOString().split('T')[0];
        const maxPublishDate = new Date(Date.now() + 86400000 * 7).toISOString().split('T')[0];

        // --- COMPONENTES AUXILIARES ---
        const MobileHeaderButton = ({ icon: Icon, label, onClick, highlight }) => (
            <button 
                onClick={onClick} 
                className={`flex flex-col items-center justify-center py-2 rounded-lg transition-all active:scale-95 border ${
                    highlight 
                    ? 'bg-[#00ff55] text-black border-[#00cc44] shadow-[0_0_10px_rgba(0,255,85,0.3)]' 
                    : 'bg-[#1a1a1a] text-gray-300 border-gray-800 hover:border-gray-600 hover:text-white'
                }`}
            >
                <Icon size={18} className={highlight ? "mb-1 text-black" : "mb-1 text-[#00ff55]"} />
                <span className="text-[9px] font-black uppercase tracking-wider">{label}</span>
            </button>
        );

        const ZoneSelectOptions = () => (<>{Object.entries(ZONES_BY_AREA).map(([region, zones]) => (<optgroup key={region} label={region} className="bg-gray-800 text-gray-300 font-bold">{zones.map(z => <option key={z} value={z} className="bg-gray-700 font-normal">{z}</option>)}</optgroup>))}</>);

        const StarRating = ({ rating }) => {
            return (
                <div className="flex items-center gap-0.5">
                    {[1, 2, 3, 4, 5].map((star) => (
                        <Star 
                            key={star} 
                            size={10} 
                            className={`${(rating || 0) >= star ? "fill-yellow-400 text-yellow-400" : "text-gray-300 fill-gray-200"}`} 
                        />
                    ))}
                </div>
            );
        };

        // --- DATOS FICTICIOS (Seeders) ---
        const INITIAL_MATCHES = [
            { date: yesterdayString, time: '20:00', place: 'Predio El Rinc√≥n', zone: 'La Plata (Casco Urbano)', format: 'F5', type: 'player', gender: 'Hombres üöπ', missing: 0, position: 'Arquero', teamName: 'Los Rotos FC', urgent: false, playersSigned: ['dummy_1', 'dummy_2'], level: 'Picado Medio ‚öΩ', applicationsCount: 0 },
            { date: today, time: '21:00', place: 'Club Atl. Villa Elisa', zone: 'Villa Elisa', format: 'F7', type: 'rival', gender: 'Mixto ‚ößÔ∏è', isChallenge: true, stake: 'La cancha ($30.000)', missing: 0, position: 'Equipo Completo', teamName: 'Defensores VE', urgent: true, level: 'A Morir (Competitivo) üèÜ', applicationsCount: 2 },
            { date: tomorrow, time: '19:00', place: 'La Plaza', zone: 'City Bell', format: 'F5', type: 'player', missing: 2, gender: 'Mujeres üö∫', position: 'Defensores', teamName: 'Inter CB', urgent: false, level: 'Tranqui / Joda üçª', applicationsCount: 5 },
        ];
        const INITIAL_PLAYERS = [
            { uid: 'dummy_1', name: 'Lucho M.', position: 'Arquero', zone: 'Villa Elisa', rating: 4.5, ratingCount: 10, status: 'Disponible', level: 'A Morir (Competitivo) üèÜ', gender: 'Hombres üöπ' },
            { uid: 'dummy_2', name: 'El Distinto', position: 'Medio', zone: 'La Plata', rating: 5.0, ratingCount: 3, status: 'Disponible', level: 'Picado Medio ‚öΩ', gender: 'Mixto ‚ößÔ∏è' },
        ];

        // --- APP PRINCIPAL ---
        const App = () => {
            const [view, setView] = useState('landing');
            const [user, setUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [checkingAuth, setCheckingAuth] = useState(true);
            
            const getFirebaseConfig = () => ({
                apiKey: "AIzaSyC8att6xIu--GeDn7uY6gHkIrwUU1UhwpM",
                authDomain: "el-enganche.firebaseapp.com",
                projectId: "el-enganche",
                storageBucket: "el-enganche.firebasestorage.app",
                messagingSenderId: "733812663281",
                appId: "1:733812663281:web:1e0ba9ca08a331930eda50"
            });

            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);

            useEffect(() => {
                 try {
                    const app = initializeApp(getFirebaseConfig());
                    const appCheck = initializeAppCheck(app, {
                        provider: new ReCaptchaV3Provider('6LdxFE4sAAAAAIcAqm8pq_mfpw1WRzVRJtHiOkP4'),
                        isTokenAutoRefreshEnabled: true
                    });
                    setAuth(getAuth(app));
                    const database = getFirestore(app);
                    setDb(database);
                    enableIndexedDbPersistence(database).catch((err) => {
                        console.log('Persistencia:', err.code);
                    });
                } catch(e) { console.error(e); }
            }, []);

            // Data States
            const [matches, setMatches] = useState([]);
            const [myFullHistoryMatches, setMyFullHistoryMatches] = useState([]);
            const [myFullJoinedMatches, setMyFullJoinedMatches] = useState([]);
            
            const [players, setPlayers] = useState([]);
            const [invitations, setInvitations] = useState([]); 
            const [myTeam, setMyTeam] = useState(null);
            const [loading, setLoading] = useState(true);
            const [submitting, setSubmitting] = useState(false);
            const [uploadingLogo, setUploadingLogo] = useState(false);
            const [showStatsDetails, setShowStatsDetails] = useState(false);
            
            // UI States
            const [showLoginModal, setShowLoginModal] = useState(false);
            const [showInviteModal, setShowInviteModal] = useState(false);
            const [showCreateTeamModal, setShowCreateTeamModal] = useState(false);
            const [showPublishModal, setShowPublishModal] = useState(false);
            const [showScoutModal, setShowScoutModal] = useState(false);
            const [showTeamSearchModal, setShowTeamSearchModal] = useState(false);
            const [showInstallModal, setShowInstallModal] = useState(false);
            const [showMapModal, setShowMapModal] = useState(false);
            const [showRatingModal, setShowRatingModal] = useState(false);
            const [showNotifications, setShowNotifications] = useState(false);
            
            const [feedbackModal, setFeedbackModal] = useState({ show: false, type: 'success', title: '', message: '' });
            
            // Filter States
            const [formatFilter, setFormatFilter] = useState('Todos');
            const [zoneFilter, setZoneFilter] = useState('Todas');
            
            // Form States
            const [inviteData, setInviteData] = useState({ place: '', time: '' });
            const [targetPlayer, setTargetPlayer] = useState(null);
            const [newTeamName, setNewTeamName] = useState('');
            const [teamLogoFile, setTeamLogoFile] = useState(null);
            const [publishData, setPublishData] = useState({ type: 'player', format: 'F5', zone: 'La Plata (Casco Urbano)', place: '', time: '', date: '', level: 'Picado Medio ‚öΩ', gender: 'Hombres üöπ', isChallenge: false, stake: '' });
            const [neededPositions, setNeededPositions] = useState(['Cualquiera']);
            const [playerPostulationLevel, setPlayerPostulationLevel] = useState('Picado Medio ‚öΩ');
            const [postulationPosition, setPostulationPosition] = useState('Polifuncional'); 
            const [playerPostulationGender, setPlayerPostulationGender] = useState('Hombres üöπ');
            
            // Edit States
            const [isEditingNickname, setIsEditingNickname] = useState(false);
            const [isEditingPosition, setIsEditingPosition] = useState(false);
            const [nicknameInput, setNicknameInput] = useState('');
            const [isEditingTeamName, setIsEditingTeamName] = useState(false);
            const [teamNameInput, setTeamNameInput] = useState('');

            // Search States
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [teamSearchQuery, setTeamSearchQuery] = useState('');
            const [teamSearchResults, setTeamSearchResults] = useState([]);
            
            const [confirmation, setConfirmation] = useState({ show: false, text: '', action: null });
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            
            const [pendingLogoFile, setPendingLogoFile] = useState(null);

            // Computed
            const isAdmin = user && ADMIN_EMAILS.includes(user.email);
            const myOrganizedMatches = user ? matches.filter(m => m.createdBy === user.uid) : [];
            const matchesJoined = user ? matches.filter(m => m.playersSigned && m.playersSigned.includes(user.uid)).length : 0; 
            const playedMatchesList = user ? matches.filter(m => m.playersSigned && m.playersSigned.includes(user.uid)) : [];
            const myPostulations = user ? players.filter(p => p.uid === user.uid) : [];
            const userRating = userProfile?.rating || 0;
            const userRatingCount = userProfile?.ratingCount || 0;
            
            const receivedNotifications = invitations.filter(inv => inv.toUserId === user?.uid && inv.status === 'pending');
            const mySentApplications = invitations.filter(inv => inv.fromUserId === user?.uid && inv.type === 'match_request' && inv.status === 'pending');

            const isCaptain = myTeam && myTeam.captainId === user?.uid;
            
            const myPlayerProfile = players.find(p => user && p.uid === user.uid);

            const handleAddSlot = () => setNeededPositions([...neededPositions, 'Cualquiera']);
            const handleRemoveSlot = (index) => setNeededPositions(neededPositions.filter((_, i) => i !== index));
            const handleSlotChange = (index, value) => {
                const newSlots = [...neededPositions];
                newSlots[index] = value;
                setNeededPositions(newSlots);
            };

            // --- AUTH & DATA SUBSCRIPTION ---
            useEffect(() => {
                if(!auth) return;
                onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        setUser(u.isAnonymous ? null : u);
                        if (!u.isAnonymous) {
                            setView('app');
                            if (db) {
                                const userRef = doc(db, 'artifacts', 'el-capitan-web', 'public', 'data', 'users', u.uid);
                                const snap = await getDoc(userRef);
                                if (!snap.exists()) {
                                    await setDoc(userRef, { uid: u.uid, name: u.displayName, nickname: u.displayName, email: u.email, position: 'Polifuncional', searchName: u.displayName ? u.displayName.toLowerCase() : '', createdAt: serverTimestamp() });
                                    setUserProfile({ position: 'Polifuncional', nickname: u.displayName });
                                } else {
                                    setUserProfile(snap.data());
                                }
                            }
                        }
                    } else {
                         try { await signInAnonymously(auth); } catch(e) { console.log("Auth anon failed", e); }
                    }
                    setCheckingAuth(false);
                });
            }, [auth, db]);

            useEffect(() => {
                if(userProfile?.position) setPostulationPosition(userProfile.position);
            }, [userProfile]);

            useEffect(() => {
                if(!user || !db || user.isAnonymous) return;
                const qCreated = query(collection(db, 'artifacts', appId, 'public', 'data', 'matches'), where('createdBy', '==', user.uid));
                const unsubCreated = onSnapshot(qCreated, (s) => {
                    setMyFullHistoryMatches(s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => new Date(b.date) - new Date(a.date)));
                });
                const qJoined = query(collection(db, 'artifacts', appId, 'public', 'data', 'matches'), where('playersSigned', 'array-contains', user.uid));
                const unsubJoined = onSnapshot(qJoined, (s) => {
                    setMyFullJoinedMatches(s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => new Date(b.date) - new Date(a.date)));
                });
                return () => { unsubCreated(); unsubJoined(); }
            }, [user, db]);

            useEffect(() => {
                if(!user || !db) return;
                const unsubTeam = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'teams'), (s) => {
                    const found = s.docs.map(d => ({id: d.id, ...d.data()})).find(t => t.captainId === user.uid || t.members?.some(m => m.uid === user.uid));
                    setMyTeam(found || null);
                });
                
                const unsubInv = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'invitations'), (s) => {
                    const all = s.docs.map(d => ({id: d.id, ...d.data()}));
                    setInvitations(all.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0)));
                });
                return () => { unsubTeam(); unsubInv(); }
            }, [user, db]);

            useEffect(() => {
                if(!db) return;
                const qM = query(collection(db, 'artifacts', appId, 'public', 'data', 'matches'), where('date', '>=', sevenDaysAgoString));
                const unsubM = onSnapshot(qM, (s) => {
                    const d = s.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    if(d.length === 0) seedMatches();
                    else setMatches(d.sort((a,b) => new Date(b.date+'T'+b.time) - new Date(a.date+'T'+a.time)));
                    setLoading(false);
                }, () => { setMatches(INITIAL_MATCHES); setLoading(false); });

                const qP = query(collection(db, 'artifacts', appId, 'public', 'data', 'players'), where('createdAt', '>', Timestamp.fromDate(new Date(Date.now() - 86400000 * 7))));
                const unsubP = onSnapshot(qP, (s) => {
                    const d = s.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    if(d.length === 0) seedPlayers();
                    else setPlayers(d);
                }, () => { setPlayers(INITIAL_PLAYERS); }); 

                return () => { unsubM(); unsubP(); }
            }, [db]);

            const seedMatches = async () => {
                if(!db) return;
                const ref = collection(db, 'artifacts', appId, 'public', 'data', 'matches');
                const snap = await getDocs(ref);
                if(snap.size === 0) {
                    for(const m of INITIAL_MATCHES) await addDoc(ref, {...m, createdBy: 'system', createdAt: serverTimestamp()});
                }
            };
            const seedPlayers = async () => {
                if(!db) return;
                const ref = collection(db, 'artifacts', appId, 'public', 'data', 'players');
                const snap = await getDocs(ref);
                if(snap.size === 0) {
                    for(const p of INITIAL_PLAYERS) await addDoc(ref, {...p, uid: 'dummy_'+Math.random(), createdAt: serverTimestamp()});
                }
            };

            // --- HELPERS ---
            const compressImageToBase64 = async (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (e) => {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX = 200; 
                            let w = img.width, h = img.height;
                            if(w>h) { if(w>MAX) { h*=MAX/w; w=MAX; } } else { if(h>MAX) { w*=MAX/h; h=MAX; } }
                            canvas.width = w; canvas.height = h;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, w, h);
                            const base64String = canvas.toDataURL('image/jpeg', 0.7);
                            resolve(base64String);
                        }
                        img.onerror = () => reject(new Error("La imagen es inv√°lida"));
                    }
                    reader.onerror = () => reject(new Error("Error al leer el archivo"));
                });
            };

            const askConfirmation = (text, action) => setConfirmation({ show: true, text, action });

            const checkUpdateAvailability = (lastUpdateTimestamp) => {
                if (!lastUpdateTimestamp) return { available: true, daysLeft: 0 };
                const lastUpdate = lastUpdateTimestamp.toDate();
                const now = new Date();
                const diffTime = Math.abs(now - lastUpdate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const daysLeft = DAYS_BETWEEN_UPDATES - diffDays;
                return { available: diffDays >= DAYS_BETWEEN_UPDATES, daysLeft: Math.max(0, daysLeft) };
            };

            // --- ACTIONS ---
            const handleGoogleLogin = async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); setView('app'); } catch(e) { alert(e.message); } };
            const handleLogout = async () => { await signOut(auth); setView('landing'); };
            const handleGuest = () => setView('app');
            const handleShareApp = () => {
                const text = "¬°Sumate a El Capit√°n! Descargala ac√°:";
                const url = window.location.href;
                window.open(`https://wa.me/?text=${encodeURIComponent(text + " " + url)}`, '_blank');
            };
            
            const handleClickHeaderButton = () => {
                if (!user) return setShowLoginModal(true);
                if (!myTeam) return setShowCreateTeamModal(true);
                if (myTeam.captainId !== user.uid) return alert("Solo el capit√°n puede publicar.");
                setShowPublishModal(true);
            };

            const handleInstallClick = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') setDeferredPrompt(null);
                } else { setShowInstallModal(true); }
            };

            // --- NUEVO SISTEMA: APLICAR A PARTIDO (SOLICITUD) ---
            const handleApplyMatch = async (match) => {
                if (!user) return setShowLoginModal(true);
                
                // Si ya es miembro (aceptado), puede salir.
                if (match.playersSigned?.includes(user.uid)) {
                     const ref = doc(db, 'artifacts', appId, 'public', 'data', 'matches', match.id);
                     try {
                         await updateDoc(ref, { missing: increment(1), playersSigned: arrayRemove(user.uid) });
                     } catch(e) { alert(e.message); }
                     return;
                }

                // VALIDACI√ìN 1: L√çMITE DE 4 SOLICITUDES ACTIVAS POR USUARIO
                if (mySentApplications.length >= MAX_ACTIVE_APPLICATIONS_PER_USER) {
                    setFeedbackModal({ show: true, type: 'error', title: 'L√çMITE ALCANZADO', message: `Ya tienes ${MAX_ACTIVE_APPLICATIONS_PER_USER} solicitudes pendientes. Espera a que te respondan.` });
                    return;
                }

                // VALIDACI√ìN 2: L√çMITE DE SOLICITUDES POR PARTIDO (10 x PUESTO)
                const maxRequestsForThisMatch = (match.missing || 1) * MAX_APPLICATIONS_PER_SLOT;
                if ((match.applicationsCount || 0) >= maxRequestsForThisMatch) {
                    setFeedbackModal({ show: true, type: 'error', title: 'CUPO LLENO', message: 'Este partido ya tiene demasiadas solicitudes pendientes.' });
                    return;
                }

                // VALIDACI√ìN 3: YA ENVIASTE SOLICITUD
                if (invitations.some(i => i.fromUserId === user.uid && i.matchId === match.id && i.status === 'pending')) {
                     setFeedbackModal({ show: true, type: 'info', title: 'YA SOLICITADO', message: 'Ya has enviado una solicitud a este partido.' });
                     return;
                }

                // ENVIAR SOLICITUD Y ACTUALIZAR CONTADOR DE POSTULACIONES DEL PARTIDO
                const matchRef = doc(db, 'artifacts', appId, 'public', 'data', 'matches', match.id);
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'invitations'), {
                        type: 'match_request', 
                        fromUserId: user.uid,
                        fromName: userProfile?.nickname || user.displayName,
                        fromTeamName: myTeam ? myTeam.name : null, 
                        matchId: match.id,
                        matchInfo: `${match.teamName} - ${match.date} ${match.time}`, 
                        toUserId: match.createdBy, 
                        status: 'pending',
                        createdAt: serverTimestamp()
                    });
                    await updateDoc(matchRef, { applicationsCount: increment(1) });
                    setFeedbackModal({ show: true, type: 'success', title: 'SOLICITUD ENVIADA', message: 'El organizador ha recibido tu petici√≥n.' });
                } catch(e) { alert(e.message); }
            };

            // --- NUEVO: CANCELAR SOLICITUD ---
            const handleCancelRequest = async (invitationId, matchId) => {
                if (!user) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'invitations', invitationId));
                    // Restamos el contador de postulaciones en el partido
                    if(matchId) {
                        const matchRef = doc(db, 'artifacts', appId, 'public', 'data', 'matches', matchId);
                        await updateDoc(matchRef, { applicationsCount: increment(-1) });
                    }
                    setFeedbackModal({ show: true, type: 'info', title: 'CANCELADA', message: 'Has cancelado la solicitud.' });
                } catch (e) { alert(e.message); }
            };

            // --- RESPONDER A SOLICITUD DE PARTIDO ---
            const handleRespondMatchRequest = async (inv, action) => {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'invitations', inv.id), { status: action });
                    
                    // Si aceptamos o rechazamos, ya no es pendiente, bajamos el contador de postulaciones
                    const matchRef = doc(db, 'artifacts', appId, 'public', 'data', 'matches', inv.matchId);
                    await updateDoc(matchRef, { applicationsCount: increment(-1) });

                    if (action === 'accepted') {
                        // Si se acepta, ocupamos un lugar en el partido
                        await updateDoc(matchRef, {
                            playersSigned: arrayUnion(inv.fromUserId),
                            missing: increment(-1) 
                        });
                        setFeedbackModal({ show: true, type: 'success', title: 'ACEPTADO', message: `${inv.fromName} se ha unido al partido.` });
                    }
                } catch (e) { alert(e.message); }
            };

            const handlePublishMatch = async (e) => {
                e.preventDefault();
                if(!user) return;
                setSubmitting(true);
                try {
                    await addDoc(collection(db, 'artifacts', 'el-capitan-web', 'public', 'data', 'matches'), {
                        ...publishData,
                        missing: publishData.type==='rival'?0:neededPositions.length,
                        position: publishData.type==='rival'?'Equipo Completo':neededPositions.join(', '),
                        teamName: myTeam ? myTeam.name : (userProfile?.nickname || user.displayName) + " Team",
                        urgent: false, playersSigned: [], createdBy: user.uid, createdAt: serverTimestamp(),
                        applicationsCount: 0 // Inicia con 0 postulaciones
                    });
                    setPublishData({ ...publishData, place: '', time: '', date: '', isChallenge: false, stake: '' });
                    setNeededPositions(['Cualquiera']);
                    setShowPublishModal(false);
                    setFeedbackModal({ show: true, type: 'success', title: '¬°PUBLICADO!', message: 'Tu partido ya est√° visible para todos.' });
                } catch(e) { alert(e.message); } finally { setSubmitting(false); }
            };

            const handleJoinAsPlayer = async () => {
                if (!user) { setShowLoginModal(true); return; }
                if (players.some(p => p.uid === user.uid)) return alert("Ya est√°s postulado como agente libre.");
                setSubmitting(true);
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'players'), {
                        uid: user.uid, 
                        name: userProfile?.nickname || user.displayName, 
                        position: postulationPosition, 
                        zone: 'La Plata',
                        level: playerPostulationLevel,
                        gender: playerPostulationGender, 
                        rating: 0, ratingCount: 0, status: 'Disponible', createdAt: serverTimestamp()
                    });
                    setFeedbackModal({ show: true, type: 'success', title: '¬°LISTO!', message: 'Te has postulado correctamente.' });
                } catch(err) { alert("Error: " + err.message); } finally { setSubmitting(false); }
            };

            // --- L√ìGICA DE ACTUALIZACI√ìN DE NICKNAME (1 MES) ---
            const confirmUpdateNickname = async () => {
                 await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid), { 
                     nickname: nicknameInput,
                     lastNicknameUpdate: serverTimestamp() 
                 });
                setUserProfile({ ...userProfile, nickname: nicknameInput, lastNicknameUpdate: Timestamp.now() });
                setIsEditingNickname(false);
                if (myPlayerProfile) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', myPlayerProfile.id), { name: nicknameInput });
            };

            const handleUpdateNickname = () => {
                if(!user || !nicknameInput.trim()) return;
                const { available, daysLeft } = checkUpdateAvailability(userProfile?.lastNicknameUpdate);
                if (!available) {
                    setFeedbackModal({ show: true, type: 'error', title: 'ESPERA UN POCO', message: `Solo puedes cambiar tu apodo una vez cada 30 d√≠as. Faltan ${daysLeft} d√≠as.` });
                    return;
                }
                askConfirmation("Est√°s a punto de cambiar tu apodo. Recuerda que debes esperar 30 d√≠as para hacerlo nuevamente. ¬øConfirmar?", confirmUpdateNickname);
            };

            const handleUpdatePosition = async (newPos) => {
                if(!user) return;
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
                await updateDoc(userRef, { position: newPos });
                setUserProfile({ ...userProfile, position: newPos });
                setPostulationPosition(newPos);
                setIsEditingPosition(false);
                if (myPlayerProfile) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', myPlayerProfile.id), { position: newPos });
            };
            
            // --- L√ìGICA DE ACTUALIZACI√ìN DE LOGO (1 MES) ---
            const processTeamLogoUpdate = async () => {
                if (!pendingLogoFile) return;
                setUploadingLogo(true);
                try {
                    const base64String = await compressImageToBase64(pendingLogoFile);
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'teams', myTeam.id), { logoUrl: base64String, lastLogoUpdate: serverTimestamp() });
                    setUploadingLogo(false); setPendingLogoFile(null);
                    setFeedbackModal({ show: true, type: 'success', title: '¬°√âXITO!', message: 'El escudo de tu equipo se ha actualizado.' });
                } catch(err) {
                    setUploadingLogo(false); setPendingLogoFile(null);
                    setFeedbackModal({ show: true, type: 'error', title: 'ERROR', message: 'No se pudo actualizar el escudo: ' + err.message });
                }
            };

            const handleUpdateTeamLogo = (e) => {
                const file = e.target.files[0];
                if (!file || !user || !myTeam) return;
                if (file.size > 10 * 1024 * 1024) { alert("El logo es muy pesado (M√°x 10MB)."); return; }
                const { available, daysLeft } = checkUpdateAvailability(myTeam.lastLogoUpdate);
                if (!available) {
                    setFeedbackModal({ show: true, type: 'error', title: 'ESPERA UN POCO', message: `Solo puedes cambiar el escudo una vez cada 30 d√≠as. Faltan ${daysLeft} d√≠as.` });
                    e.target.value = null; return;
                }
                setPendingLogoFile(file);
                askConfirmation("Est√°s a punto de cambiar el escudo. Recuerda que debes esperar 30 d√≠as para hacerlo nuevamente. ¬øConfirmar?", processTeamLogoUpdate);
                e.target.value = null;
            };

            // --- L√ìGICA DE ACTUALIZACI√ìN DE NOMBRE DE EQUIPO (1 MES) ---
            const confirmUpdateTeamName = async () => {
                if (!teamNameInput.trim()) return;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'teams', myTeam.id), { name: teamNameInput, searchName: teamNameInput.toLowerCase(), lastNameUpdate: serverTimestamp() });
                setIsEditingTeamName(false);
                setFeedbackModal({ show: true, type: 'success', title: '¬°√âXITO!', message: 'Nombre del equipo actualizado.' });
            };

            const handleUpdateTeamName = () => {
                if (!teamNameInput.trim()) return;
                const { available, daysLeft } = checkUpdateAvailability(myTeam.lastNameUpdate);
                if (!available) {
                    setFeedbackModal({ show: true, type: 'error', title: 'ESPERA UN POCO', message: `Solo puedes cambiar el nombre del equipo una vez cada 30 d√≠as. Faltan ${daysLeft} d√≠as.` });
                    return;
                }
                askConfirmation("Est√°s a punto de cambiar el nombre del equipo. Recuerda que debes esperar 30 d√≠as para hacerlo nuevamente. ¬øConfirmar?", confirmUpdateTeamName);
            };

            const handleDeletePlayer = (id) => {
                if (!user) return;
                if (isAdmin || players.find(p=>p.id===id)?.uid === user?.uid) {
                    askConfirmation("¬øVas a eliminar a este jugador de la lista?", async () => await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', id)));
                }
            };
            const handleDeleteMatch = (idMatch) => {
                if (!user) return;
                const match = matches.find(m => m.id === idMatch);
                const isCreator = match && match.createdBy === user.uid;
                if(isAdmin || isCreator) {
                    askConfirmation("¬øVas a eliminar este partido permanentemente?", async () => await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', idMatch)));
                }
            };
            
            const handleDeleteTeam = async () => {
                if(!user || !myTeam) return;
                askConfirmation("¬øEst√°s seguro de que quieres disolver el equipo?", async () => {
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'teams', myTeam.id));
                        setMyTeam(null);
                        alert("Equipo disuelto.");
                    } catch(e) { alert("Error: " + e.message); }
                });
            };

            const handleLeaveTeam = async () => {
                if(!user || !myTeam) return;
                askConfirmation("¬øSalir del equipo?", async () => {
                    try {
                          const updatedMembers = myTeam.members.filter(m => m.uid !== user.uid);
                          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'teams', myTeam.id), { members: updatedMembers });
                          setMyTeam(null);
                    } catch(e) { alert(e.message); }
                });
            };
            
            const handleCreateTeam = async (e) => {
                e.preventDefault();
                if (!user || !newTeamName) return;
                setSubmitting(true);
                try {
                    let logoUrl = "";
                    if (teamLogoFile) {
                        logoUrl = await compressImageToBase64(teamLogoFile);
                    }
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'teams'), {
                        name: newTeamName, captainId: user.uid, captainName: userProfile?.nickname || user.displayName, logoUrl: logoUrl,
                        members: [{ uid: user.uid, name: userProfile?.nickname || user.displayName, role: 'captain', status: 'active' }],
                        searchName: newTeamName.toLowerCase(), createdAt: serverTimestamp(), lastLogoUpdate: serverTimestamp(), lastNameUpdate: serverTimestamp()
                    });
                    setNewTeamName(''); setTeamLogoFile(null); setShowCreateTeamModal(false); setView('team');
                    setFeedbackModal({ show: true, type: 'success', title: '¬°EQUIPO CREADO!', message: 'Ahora eres el capit√°n.' });
                } catch(err) { alert("Error: " + err.message); } finally { setSubmitting(false); }
            };

            const handleCreateDemoTeam = async () => {
                if (!user) return;
                const demoPlayers = [{ uid: 'd1', name: 'Esteban', role: 'player', status: 'active' }, { uid: 'd2', name: 'Pedro', role: 'player', status: 'active' }];
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'teams'), {
                    name: "Dream Team (Demo)", captainId: user.uid, captainName: userProfile?.nickname || user.displayName,
                    members: [{ uid: user.uid, name: userProfile?.nickname || user.displayName, role: 'captain', status: 'active' }, ...demoPlayers],
                    searchName: "dream team demo", createdAt: serverTimestamp()
                });
                alert("Equipo Demo Generado!");
            };
            
            const handleToggleMemberStatus = async (memberUid, currentStatus) => {
                if (!myTeam || !user) return;
                if (isCaptain || user.uid === memberUid) {
                    const newStatus = currentStatus === 'active' ? 'injured' : 'active';
                    const updatedMembers = myTeam.members.map(m => m.uid === memberUid ? { ...m, status: newStatus } : m);
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'teams', myTeam.id), { members: updatedMembers });
                } else {
                    alert("Solo el capit√°n o el propio jugador pueden cambiar este estado.");
                }
            };

            const handleSearchUsers = async (e) => {
                e.preventDefault(); if (!searchQuery.trim()) return;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('searchName', '>=', searchQuery.toLowerCase()), where('searchName', '<=', searchQuery.toLowerCase() + '\uf8ff'));
                const snaps = await getDocs(q); setSearchResults(snaps.docs.map(d => d.data()));
            };
            const handleSearchTeams = async (e) => {
                e.preventDefault(); if (!teamSearchQuery.trim()) return;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'teams'), where('searchName', '>=', teamSearchQuery.toLowerCase()), where('searchName', '<=', teamSearchQuery.toLowerCase() + '\uf8ff'));
                const snaps = await getDocs(q); setTeamSearchResults(snaps.docs.map(d => ({id: d.id, ...d.data()})));
            };

            const sendSystemInvite = async (targetUser) => {
                if (!user || !myTeam) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'invitations'), { type: 'recruit', fromUserId: user.uid, fromName: userProfile?.nickname || user.displayName, teamId: myTeam.id, teamName: myTeam.name, toUserId: targetUser.uid, toPlayerName: targetUser.nickname || targetUser.name, place: "Fichaje", time: "General", status: 'pending', createdAt: serverTimestamp() });
                alert("Solicitud enviada.");
            };
            const sendJoinRequest = async (targetTeam) => {
                if (!user) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'invitations'), { type: 'join_request', fromUserId: user.uid, fromName: userProfile?.nickname || user.displayName, teamId: targetTeam.id, teamName: targetTeam.name, toUserId: targetTeam.captainId, status: 'pending', createdAt: serverTimestamp() });
                alert("Solicitud enviada"); setShowTeamSearchModal(false);
            };
            const openInviteModal = (player) => {
                if (!user) { setShowLoginModal(true); return; }
                if (!myTeam || myTeam.captainId !== user.uid) { alert("Solo capitanes."); return; }
                setTargetPlayer(player); setInviteData({ place: '', time: '' }); setShowInviteModal(true);
            };

            const sendInvitation = async (e) => {
                e.preventDefault();
                if (!user || !myTeam || !targetPlayer) return;
                setSubmitting(true);
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'invitations'), {
                        type: 'recruit', fromUserId: user.uid, fromName: userProfile?.nickname || user.displayName, teamId: myTeam.id, teamName: myTeam.name,
                        toUserId: targetPlayer.uid, toPlayerName: targetPlayer.name, place: inviteData.place, time: inviteData.time, status: 'pending', createdAt: serverTimestamp()
                    });
                    setShowInviteModal(false); setInviteData({ place: '', time: '' }); alert(`¬°Invitaci√≥n enviada!`);
                } catch (err) { alert("Error: " + err.message); } finally { setSubmitting(false); }
            };

            const handleRespondInvitation = async (inv, response) => {
                if (!user) return;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'invitations', inv.id), { status: response });
                if (response === 'accepted') {
                    const teamRef = doc(db, 'artifacts', appId, 'public', 'data', 'teams', inv.teamId);
                    const snap = await getDoc(teamRef);
                    if (snap.exists() && !snap.data().members.some(m => m.uid === (inv.type === 'join_request' ? inv.fromUserId : user.uid))) {
                        const uidToAdd = inv.type === 'join_request' ? inv.fromUserId : user.uid;
                        const nameToAdd = inv.type === 'join_request' ? inv.fromName : (userProfile?.nickname || user.displayName);
                        await updateDoc(teamRef, { members: arrayUnion({ uid: uidToAdd, name: nameToAdd, role: 'player', status: 'active' }) });
                        alert(`¬°${nameToAdd} se uni√≥ a ${inv.teamName}!`);
                    }
                }
            };
            const mockAction = (msg) => { if(!user) return setShowLoginModal(true); alert(msg); }

            // --- VISTAS ---
            if (checkingAuth) {
                return (
                    <div className="flex-1 flex items-center justify-center bg-black h-screen">
                         <div className="flex flex-col items-center gap-4">
                             <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-[#00ff55]"></div>
                             <div className="text-[#00ff55] font-bold text-sm tracking-widest animate-pulse">VERIFICANDO SESI√ìN...</div>
                         </div>
                    </div>
                );
            }

            if (view === 'landing') {
                return (
                    <div className="flex-1 flex flex-col items-center justify-center p-6 text-center bg-gradient-to-br from-[#003300] to-[#001a00] relative overflow-hidden h-screen">
                        <div className="absolute inset-0 bg-[radial-gradient(circle_at_50%_0%,_rgba(0,255,85,0.1),_transparent_70%)]"></div>
                        <div className="z-10 mb-12 transform hover:scale-105 transition-transform duration-500 flex flex-col items-center">
                            <img src="https://i.imgur.com/F7p7sXT.png" alt="El Capit√°n" className="w-64 sm:w-80 object-contain drop-shadow-[0_0_15px_rgba(0,255,85,0.3)]" />
                        </div>
                        <div className="z-10 w-full max-w-sm space-y-4">
                            {user ? (
                                userProfile ? (
                                    <button onClick={() => setView('app')} className="w-full bg-[#00ff55] hover:bg-white text-black font-black py-4 rounded-xl shadow-[0_0_20px_rgba(0,255,85,0.4)] flex items-center justify-center gap-2 uppercase tracking-wide transition-all"><User size={24}/> Continuar como {userProfile.nickname}</button>
                                ) : (
                                    <div className="w-full bg-[#002200] text-[#00ff55] font-bold py-4 rounded-xl flex items-center justify-center gap-2 animate-pulse">Cargando perfil...</div>
                                )
                            ) : (
                                <button onClick={handleGoogleLogin} className="w-full bg-white hover:bg-gray-100 text-gray-800 font-bold py-3 px-4 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all active:scale-95 border border-gray-200">
                                    <svg className="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.17c-.22-.66-.35-1.36-.35-2.17s.13-1.51.35-2.17V7.61H2.18C.79 10.37.79 13.63 2.18 16.39l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.05l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                                    Continuar con Google
                                </button>
                            )}
                            <button onClick={handleGuest} className="w-full bg-white/5 hover:bg-white/10 text-[#00ff55] border-2 border-[#00ff55]/50 font-bold py-4 rounded-xl flex items-center justify-center gap-2 transition-all"><Users size={20}/> Entrar como Invitado</button>
                        </div>
                    </div>
                );
            }

            // FEED FILTRADO
            const feedMatches = matches.filter(m => 
                (formatFilter === 'Todos' || m.format === formatFilter) && 
                (zoneFilter === 'Todas' || m.zone === zoneFilter) &&
                (m.date >= yesterdayString)
            );

            return (
                <div className="flex-1 flex flex-col pb-24">
                    <header className="bg-gradient-to-r from-[#003300] to-[#004d26] border-b-4 border-[#00ff55] sticky top-0 z-50 shadow-xl">
                        {/* HEADER M√ìVIL */}
                        <div className="sm:hidden flex flex-col w-full">
                            <div className="flex justify-between items-center px-4 py-2 border-b border-white/10 bg-[#001a00]">
                                <img src="https://i.imgur.com/aVwYCPF.png" alt="El Capit√°n" className="h-8 object-contain" />
                                <div className="flex items-center">
                                    {user ? (
                                        <button className="relative p-2 text-gray-300 hover:text-white" onClick={() => setShowNotifications(!showNotifications)}>
                                            <Bell size={22} className={receivedNotifications.length > 0 ? "text-[#00ff55] animate-pulse" : ""} />
                                            {receivedNotifications.length > 0 && <span className="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-[#003300]"></span>}
                                        </button>
                                    ) : (
                                        <button onClick={() => setShowLoginModal(true)} className="text-[10px] font-bold text-[#00ff55] border border-[#00ff55] px-2 py-1 rounded flex items-center gap-1 uppercase">INGRESAR</button>
                                    )}
                                </div>
                            </div>
                            <div className="grid grid-cols-4 gap-1 p-2 bg-[#002200]">
                                <MobileHeaderButton icon={Share2} label="Invitar" onClick={handleShareApp} />
                                <MobileHeaderButton icon={PlusCircle} label={!myTeam ? "Crear" : "Publicar"} onClick={handleClickHeaderButton} highlight={true} />
                                <MobileHeaderButton icon={Download} label="App" onClick={handleInstallClick} />
                                <MobileHeaderButton icon={MapPin} label="Canchas" onClick={() => setShowMapModal(true)} />
                            </div>
                        </div>

                        {/* HEADER DESKTOP */}
                        <div className="hidden sm:flex h-16 px-4 items-center justify-between">
                            <div className="flex items-center gap-4">
                                <img src="https://i.imgur.com/aVwYCPF.png" alt="El Capit√°n" className="h-10 object-contain" />
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="flex gap-2">
                                    <button onClick={handleClickHeaderButton} className="bg-[#00ff55] text-black px-3 py-1.5 rounded font-bold text-xs flex items-center gap-2 hover:bg-white transition-colors"><PlusCircle size={14}/> {!myTeam ? "CREAR EQUIPO" : "PUBLICAR"}</button>
                                    <button onClick={() => setShowMapModal(true)} className="text-white hover:text-[#00ff55] text-xs font-bold flex items-center gap-1 transition-colors"><MapPin size={14}/> CANCHAS</button>
                                </div>
                                {user ? (
                                    <button onClick={() => setShowNotifications(!showNotifications)} className="text-white relative ml-2 hover:text-[#00ff55] transition-colors"><Bell size={20}/></button>
                                ) : (
                                    <button onClick={() => setShowLoginModal(true)} className="text-[#00ff55] font-bold text-xs ml-2 border border-[#00ff55] px-3 py-1 rounded hover:bg-[#00ff55] hover:text-black transition-colors">INGRESAR</button>
                                )}
                            </div>
                        </div>

                        {/* NOTIFICACIONES */}
                        {showNotifications && (
                            <div className="absolute top-14 right-2 w-72 bg-[#1a1a1a] border border-gray-700 rounded-lg shadow-2xl z-[100]">
                                <div className="p-3 bg-gray-900 border-b border-gray-800 text-xs font-bold text-gray-400">Notificaciones ({receivedNotifications.length})</div>
                                <div className="max-h-64 overflow-y-auto">
                                    {receivedNotifications.length > 0 ? receivedNotifications.map(inv => (
                                        <div key={inv.id} className="p-2 border-b border-gray-800">
                                            {inv.type === 'match_request' ? (
                                                <>
                                                    <div className="text-[#00ff55] text-sm font-bold">{inv.fromName} {inv.fromTeamName ? `(${inv.fromTeamName})` : ''}</div>
                                                    <div className="text-xs text-gray-400 mb-2">Quiere unirse a: <span className="text-white">{inv.matchInfo}</span></div>
                                                    <div className="flex gap-2">
                                                        <button onClick={() => handleRespondMatchRequest(inv, 'rejected')} className="flex-1 bg-red-900/50 text-red-400 text-[10px] py-1 rounded hover:bg-red-900"><X size={12} className="inline mr-1"/> Rechazar</button>
                                                        <button onClick={() => handleRespondMatchRequest(inv, 'accepted')} className="flex-1 bg-green-900/50 text-[#00ff55] text-[10px] py-1 rounded hover:bg-green-900"><Check size={12} className="inline mr-1"/> Aceptar</button>
                                                    </div>
                                                </>
                                            ) : (
                                                <>
                                                    <div className="text-[#00ff55] text-sm font-bold">{inv.teamName}</div>
                                                    <div className="text-xs text-gray-400">Te invita a jugar.</div>
                                                </>
                                            )}
                                        </div>
                                    )) : <div className="p-4 text-center text-xs text-gray-500">Sin novedades</div>}
                                </div>
                            </div>
                        )}
                    </header>

                    {/* MAIN CONTENT */}
                    <main className="flex-1 max-w-6xl mx-auto w-full p-2 sm:p-4 grid grid-cols-1 lg:grid-cols-12 gap-6">
                        {/* VISTA: INICIO (FEED) */}
                        {view === 'app' && (
                            <>
                                <div className="lg:col-span-8 space-y-4">
                                    <div className="bg-gradient-to-r from-[#1b4d2e] to-[#2e7d32] px-4 py-3 rounded-t-lg border-b-2 border-[#4caf50] flex flex-wrap gap-2 justify-between items-center text-white">
                                        <h2 className="font-bold flex items-center gap-2"><Calendar size={20} className="text-[#00ff55]"/> PARTIDOS</h2>
                                        <div className="flex gap-2">
                                            <select className="bg-black/30 rounded text-xs p-1 outline-none border border-white/20" onChange={e => setFormatFilter(e.target.value)}><option value="Todos">Fmt: Todos</option><option value="F5">F5</option><option value="F7">F7</option></select>
                                            <select className="bg-black/30 rounded text-xs p-1 outline-none border border-white/20" onChange={e => setZoneFilter(e.target.value)}><option value="Todas">Zonas: Todas</option><ZoneSelectOptions/></select>
                                        </div>
                                    </div>
                                    <div className="bg-[#dce6dc] rounded-b-lg overflow-hidden text-gray-800 min-h-[200px]">
                                        {loading ? <div className="p-8 text-center text-gray-500">Cargando la cancha...</div> : 
                                         feedMatches.map(m => {
                                            const isSigned = m.playersSigned?.includes(user?.uid);
                                            const pendingInvitation = invitations.find(i => i.fromUserId === user?.uid && i.matchId === m.id && i.status === 'pending');
                                            const isPending = !!pendingInvitation;
                                            
                                            // NUEVO: CONTADOR VISIBLE PARA TODOS
                                            const appCount = m.applicationsCount || 0;

                                            return (
                                                <div key={m.id} className="p-3 border-b border-gray-300 flex justify-between items-center bg-white hover:bg-gray-50">
                                                    <div>
                                                        <div className="font-bold text-sm flex items-center gap-2">
                                                            {m.teamName} <span className="bg-black text-[#00ff55] text-[9px] px-1 rounded">{m.format}</span>
                                                            {m.isChallenge && <span className="text-[9px] bg-yellow-400 text-black px-1 rounded font-black flex gap-1"><Trophy size={8}/> DESAF√çO</span>}
                                                            {m.gender && <span className="text-[9px] bg-gray-200 text-black px-1 rounded">{m.gender}</span>}
                                                        </div>
                                                        <div className="text-xs text-gray-600 flex items-center gap-1 mt-1"><MapPin size={10}/> {m.place} | {m.zone}</div>
                                                        <div className="flex items-center gap-2 mt-1">
                                                            <div className="text-xs font-mono font-bold text-green-800">{m.date === today ? 'HOY' : m.date} - {m.time}</div>
                                                            <span className="text-[9px] bg-gray-200 px-1 rounded text-gray-600">{m.level}</span>
                                                        </div>
                                                        {m.isChallenge && <div className="text-[10px] text-yellow-700 font-bold mt-1">üî• {m.stake}</div>}
                                                        
                                                        {/* NUEVO: CONTADOR DE POSTULACIONES (VISIBLE PARA TODOS) */}
                                                        {appCount > 0 && (
                                                            <div className="text-[10px] text-blue-600 font-bold mt-1 flex items-center gap-1">
                                                                <Inbox size={10}/> {appCount} Postulaciones
                                                            </div>
                                                        )}
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        {(isAdmin || (user && m.createdBy === user.uid)) && <button onClick={() => { askConfirmation("¬øBorrar?", async () => await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', m.id))) }} className="text-red-500 bg-red-100 p-1.5 rounded"><Trash2 size={14}/></button>}
                                                        <button 
                                                            onClick={() => {
                                                                if (isSigned) handleApplyMatch(m); 
                                                                else if (isPending) handleCancelRequest(pendingInvitation.id, m.id); 
                                                                else handleApplyMatch(m);
                                                            }}
                                                            className={`px-3 py-1.5 rounded text-xs font-bold border-b-2 transition-all active:scale-95 ${
                                                                isSigned ? 'bg-red-600 text-white border-red-800 hover:bg-red-700' : 
                                                                isPending ? 'bg-yellow-500 text-black border-yellow-600 hover:bg-yellow-400' :
                                                                'bg-[#008f45] text-white border-[#006400] hover:bg-[#007a3b]'
                                                            }`}
                                                        >
                                                            {isSigned ? 'Salir' : isPending ? 'CANCELAR SOLICITUD' : 'ENVIAR SOLICITUD'}
                                                        </button>
                                                    </div>
                                                </div>
                                            );
                                         })}
                                    </div>
                                </div>
<!-- ... rest of the code is unchanged ... -->
